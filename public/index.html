<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê± Rat-a-Tat Cat Online</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }

        /* MENU SCREEN */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        /* GAME INFO */
        .game-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .game-id {
            text-align: center;
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .player-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* CARD STYLES */
        .card {
            width: 80px;
            height: 120px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            user-select: none;
            transform-style: preserve-3d;
        }

        .card.flipping {
            animation: cardFlip 0.6s ease-in-out;
        }

        @keyframes cardFlip {
            0% {
                transform: rotateY(0deg);
            }
            50% {
                transform: rotateY(90deg);
            }
            100% {
                transform: rotateY(0deg);
            }
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card.hidden {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .card.number {
            background: white;
            border: 3px solid #333;
            color: #333;
        }

        .card.power {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 0.7em;
            text-align: center;
            padding: 5px;
        }

        .card.clickable {
            border: 3px solid #10b981;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.7);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* HOVER REVEAL FOR OUTER CARDS */
        .card.hoverable {
            position: relative;
        }

        .card.hoverable::after {
            content: attr(data-hover-content);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border: 3px solid #fbbf24;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            color: #333;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .card.hoverable.power-hover::after {
            font-size: 0.7em;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .card.hoverable:hover::after {
            opacity: 1;
        }

        /* DECK AREA */
        .deck-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .pile {
            text-align: center;
        }

        .pile-label {
            font-weight: bold;
            margin-top: 10px;
            color: #333;
        }

        .card.deck {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .card.discard {
            background: white;
            border: 3px solid #333;
        }

        .card.drawn {
            background: #ffd700;
            border: 3px solid #ff8c00;
            animation: draw-pulse 1s infinite;
        }

        @keyframes draw-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* PLAYERS AREA */
        .players-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .player-zone {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border: 3px solid transparent;
        }

        .player-zone.me {
            background: #e0f2fe;
            border-color: #0284c7;
        }

        .player-zone.current-turn {
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .turn-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .player-cards {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .player-cards .card {
            width: 60px;
            height: 90px;
            font-size: 1.5em;
        }

        /* STATUS MESSAGES */
        .status {
            background: #dbeafe;
            color: #1e40af;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status.knock {
            background: #fef3c7;
            color: #92400e;
        }

        /* ACTION PANEL */
        .action-panel {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .action-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }

        /* ERROR MESSAGES */
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .error.show {
            display: block;
        }

        /* RULES */
        .rules {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .rules h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .rules ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .rules li {
            margin-bottom: 8px;
        }

        /* SCORES */
        .scores {
            margin-top: 20px;
        }

        .score-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #e0e0e0;
        }

        .score-item.winner {
            background: #d1fae5;
            border-color: #10b981;
        }

        .score-value {
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üê± Rat-a-Tat Cat üê±</h1>
        <p class="subtitle">The Memory Card Game (with Add Card twist!)</p>

        <div id="error" class="error"></div>

        <!-- MENU SCREEN -->
        <div id="menuScreen" class="screen active">
            <div class="input-group">
                <label for="playerName">Your Name:</label>
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="createGame()">Create New Game</button>
            </div>

            <div class="input-group" style="margin-top: 30px;">
                <label for="gameIdInput">Or Join Existing Game:</label>
                <input type="text" id="gameIdInput" placeholder="Enter game code" maxlength="10" style="text-transform: uppercase;">
            </div>

            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="joinGame()">Join Game</button>
            </div>

            <div class="rules">
                <h3>üìú How to Play:</h3>
                <ul>
                    <li><strong>Goal:</strong> Get the lowest score!</li>
                    <li><strong>Setup:</strong> Everyone gets 4 face-down cards. <strong>Hover over your leftmost and rightmost cards to peek!</strong></li>
                    <li><strong>Your Turn:</strong>
                        <ul>
                            <li>Draw from deck: Can use, use power, or discard</li>
                            <li>Draw from discard: MUST swap with one of your cards</li>
                        </ul>
                    </li>
                    <li><strong>Power Cards:</strong>
                        <ul>
                            <li>üëÅÔ∏è <strong>Peek:</strong> Look at any of your cards permanently</li>
                            <li>üîÑ <strong>Swap:</strong> Blind swap with opponent</li>
                            <li>‚ûï <strong>Draw 2:</strong> Draw 2 more cards (chains!)</li>
                            <li>üé¥ <strong>Add Card (NEW!):</strong> Force opponent to draw an extra card!</li>
                        </ul>
                    </li>
                    <li><strong>Knock:</strong> When you think you have the lowest score, knock to end the round</li>
                    <li><strong>Scoring:</strong> Number cards = face value, lowest wins!</li>
                </ul>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="gameScreen" class="screen">
            <div class="game-info">
                <div class="game-id">Game Code: <span id="gameId"></span></div>
                <div class="players-list" id="playersList"></div>
                <button id="startBtn" class="btn btn-success" onclick="startGame()" style="width: 100%; margin-top: 10px;">
                    Start Game
                </button>
            </div>

            <div id="status" class="status" style="display: none;"></div>

            <div id="gameBoard" style="display: none;">
                <!-- DECK AREA -->
                <div class="deck-area">
                    <div class="pile">
                        <div class="card deck" onclick="drawFromDeck()">
                            <div>üé¥</div>
                            <div style="font-size: 0.4em; position: absolute; bottom: 5px;" id="deckCount"></div>
                        </div>
                        <div class="pile-label">Draw Pile</div>
                    </div>

                    <div id="drawnCardPile" class="pile" style="display: none;">
                        <div class="card drawn" id="drawnCard"></div>
                        <div class="pile-label">Drawn Card</div>
                    </div>

                    <div class="pile">
                        <div class="card discard" id="discardCard" onclick="drawFromDiscard()"></div>
                        <div class="pile-label">Discard Pile</div>
                    </div>
                </div>

                <!-- ACTION PANEL -->
                <div id="actionPanel" class="action-panel" style="display: none;">
                    <div class="action-title" id="actionTitle"></div>
                    <div class="action-buttons" id="actionButtons"></div>
                </div>

                <!-- PLAYERS AREA -->
                <div class="players-area" id="playersArea"></div>

                <!-- SCORES (shown at round end) -->
                <div id="scoresArea" style="display: none;">
                    <h2 style="text-align: center; color: #667eea; margin-top: 30px;">üèÜ Round Results</h2>
                    <div class="scores" id="scores"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="startGame()">Next Round</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let gameState = null;
        let myId = null;

        // Swap card flow state
        let swapState = {
            active: false,
            step: 'select-my-card', // 'select-my-card' | 'select-opponent' | 'select-opponent-card'
            myCardIndex: null,
            opponentId: null,
            opponentCardIndex: null
        };

        function resetSwapState() {
            swapState = {
                active: false,
                step: 'select-my-card',
                myCardIndex: null,
                opponentId: null,
                opponentCardIndex: null
            };
        }

        socket.on('connect', () => {
            myId = socket.id;
            console.log('Connected:', myId);
        });

        socket.on('gameCreated', (data) => {
            showScreen('gameScreen');
            document.getElementById('gameId').textContent = data.gameId;
            updateGameState(data.gameState);
        });

        socket.on('gameState', (state) => {
            // Reset swap state when game state updates (e.g., after swap completes)
            if (!state.drawnCard || state.drawnCard.type !== 'swap') {
                resetSwapState();
            }
            updateGameState(state);
        });

        socket.on('error', (message) => {
            showError(message);
        });

        socket.on('cardRevealed', ({ card, index }) => {
            // Show the peeked card in a clear modal overlay
            const cardDisplay = card.type === 'number' ? card.value : getPowerCardName(card.type);
            const cardEmoji = card.type === 'number' ? 'üé¥' : getPowerCardEmoji(card.type);
            
            showPeekModal(cardDisplay, cardEmoji, index + 1);
        });

        // ============ UI FUNCTIONS ============

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 3000);
        }

        function showPeekModal(cardDisplay, emoji, cardPosition) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s;
            `;
            
            // Create card display
            const cardDiv = document.createElement('div');
            cardDiv.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                animation: scaleIn 0.3s;
            `;
            
            cardDiv.innerHTML = `
                <div style="font-size: 4em; margin-bottom: 20px;">${emoji}</div>
                <div style="font-size: 2.5em; font-weight: bold; color: #667eea; margin-bottom: 10px;">
                    ${cardDisplay}
                </div>
                <div style="font-size: 1.2em; color: #666; margin-bottom: 30px;">
                    Card ${cardPosition} peeked!
                </div>
                <button class="btn btn-primary" onclick="this.closest('[style*=fixed]').remove()">
                    Got it! ‚úì
                </button>
            `;
            
            modal.appendChild(cardDiv);
            document.body.appendChild(modal);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.style.animation = 'fadeOut 0.2s';
                    setTimeout(() => modal.remove(), 200);
                }
            }, 5000);
            
            // Close on click outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function getPowerCardName(type) {
            switch(type) {
                case 'peek': return 'PEEK';
                case 'swap': return 'SWAP';
                case 'draw2': return 'DRAW 2';
                case 'addcard': return 'ADD CARD';
                default: return 'UNKNOWN';
            }
        }

        function getPowerCardEmoji(type) {
            switch(type) {
                case 'peek': return 'üëÅÔ∏è';
                case 'swap': return 'üîÑ';
                case 'draw2': return '‚ûï';
                case 'addcard': return 'üé¥';
                default: return '‚ùì';
            }
        }

        function createGame() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                showError('Please enter your name');
                return;
            }
            socket.emit('createGame', { playerName: name });
        }

        function joinGame() {
            const name = document.getElementById('playerName').value.trim();
            const gameId = document.getElementById('gameIdInput').value.trim().toUpperCase();
            
            if (!name || !gameId) {
                showError('Please enter your name and game code');
                return;
            }
            
            socket.emit('joinGame', { gameId, playerName: name });
            showScreen('gameScreen');
            document.getElementById('gameId').textContent = gameId;
        }

        function startGame() {
            socket.emit('startRound');
        }

        // ============ GAME STATE UPDATE ============

        function updateGameState(state) {
            gameState = state;
            console.log('Game state updated:', state);

            // Update players list
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = state.players.map(p => 
                `<div class="player-badge">${p.name}${p.id === myId ? ' (You)' : ''}</div>`
            ).join('');

            // Show/hide start button
            const startBtn = document.getElementById('startBtn');
            startBtn.style.display = state.gameStarted ? 'none' : 'block';

            // Show game board if started
            if (state.gameStarted && !state.roundEnded) {
                document.getElementById('gameBoard').style.display = 'block';
                document.getElementById('scoresArea').style.display = 'none';
                updateGameBoard(state);
            } else if (state.roundEnded) {
                // FIX: Update the game board FIRST to show revealed cards
                document.getElementById('gameBoard').style.display = 'block';
                updateGameBoard(state);
                // THEN show the scores
                showScores(state);
            }
        }

        function updateGameBoard(state) {
            // Update status
            updateStatus(state);

            // Update deck count
            document.getElementById('deckCount').textContent = state.deckSize;

            // Update discard pile
            if (state.discardTop) {
                renderCard(document.getElementById('discardCard'), state.discardTop);
            }

            // Update drawn card
            if (state.drawnCard && state.isMyTurn) {
                document.getElementById('drawnCardPile').style.display = 'block';
                renderCard(document.getElementById('drawnCard'), state.drawnCard);
                showActionPanel(state);
            } else {
                document.getElementById('drawnCardPile').style.display = 'none';
                document.getElementById('actionPanel').style.display = 'none';
            }

            // Update players
            updatePlayersArea(state);
        }

        function updateStatus(state) {
            const statusEl = document.getElementById('status');
            statusEl.style.display = 'block';
            statusEl.className = 'status';

            if (state.knockerId) {
                const knocker = state.players.find(p => p.id === state.knockerId);
                statusEl.textContent = `üîî ${knocker.name} knocked! Final round...`;
                statusEl.classList.add('knock');
            } else if (state.isMyTurn && !state.drawnCard) {
                statusEl.textContent = 'üéØ YOUR TURN! Draw a card from the deck or discard pile';
            } else if (state.isMyTurn && state.drawnCard) {
                statusEl.textContent = 'üéØ YOUR TURN! Choose an action below';
            } else {
                const currentPlayer = state.players.find(p => p.id === state.currentPlayerId);
                statusEl.textContent = `‚è≥ Waiting for ${currentPlayer?.name || 'player'}...`;
            }
        }

        function updatePlayersArea(state) {
            const area = document.getElementById('playersArea');
            area.innerHTML = '';

            state.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-zone';
                if (player.id === myId) div.classList.add('me');
                if (player.id === state.currentPlayerId) div.classList.add('current-turn');

                // Highlight during swap opponent selection
                if (swapState.active && swapState.step === 'select-opponent' && player.id !== myId) {
                    div.style.cursor = 'pointer';
                    div.style.border = '3px solid #10b981';
                    div.onclick = () => selectSwapOpponent(player.id);
                }

                let nameHtml = `<div class="player-name">${player.name}`;
                if (player.id === myId) nameHtml += ' (You)';
                if (player.id === state.currentPlayerId) nameHtml += '<span class="turn-badge">TURN</span>';
                nameHtml += '</div>';

                const cardsDiv = document.createElement('div');
                cardsDiv.className = 'player-cards';

                player.hand.forEach((cardData, idx) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'card';

                    if (cardData.isKnown) {
                        renderCard(cardEl, cardData.card);
                    } else if (player.id === myId && cardData.isOuter) {
                        // My outer cards - hoverable!
                        renderCard(cardEl, { type: 'hidden' });
                        cardEl.classList.add('hoverable');
                        const hoverContent = getCardDisplay(cardData.card);
                        cardEl.setAttribute('data-hover-content', hoverContent);
                        if (cardData.card.type !== 'number') {
                            cardEl.classList.add('power-hover');
                        }
                    } else {
                        renderCard(cardEl, { type: 'hidden' });
                    }

                    // Make clickable for actions
                    if (player.id === myId && state.isMyTurn && state.drawnCard) {
                        if (state.drawnCard.type === 'number') {
                            // Can replace any card
                            cardEl.classList.add('clickable');
                            cardEl.onclick = () => replaceCard(idx);
                        } else if (state.drawnCard.type === 'swap' && swapState.active) {
                            // Swap flow - step 1: select my card
                            if (swapState.step === 'select-my-card') {
                                cardEl.classList.add('clickable');
                                cardEl.onclick = () => selectMyCardForSwap(idx);
                            }
                        }
                    }

                    // Make opponent cards clickable during swap step 3
                    if (swapState.active && swapState.step === 'select-opponent-card' && player.id === swapState.opponentId) {
                        cardEl.classList.add('clickable');
                        cardEl.onclick = () => selectOpponentCardForSwap(idx);
                    }

                    cardsDiv.appendChild(cardEl);
                });

                div.innerHTML = nameHtml;
                div.appendChild(cardsDiv);
                area.appendChild(div);
            });
        }

        function showActionPanel(state) {
            const panel = document.getElementById('actionPanel');
            const title = document.getElementById('actionTitle');
            const buttons = document.getElementById('actionButtons');
            
            panel.style.display = 'block';
            buttons.innerHTML = '';

            const card = state.drawnCard;

            if (card.type === 'number') {
                title.textContent = `You drew: ${card.value} - Click one of your cards to swap, or:`;
                
                if (!state.drawnFromDiscard) {
                    const discardBtn = document.createElement('button');
                    discardBtn.className = 'btn btn-secondary';
                    discardBtn.textContent = 'Discard This Card';
                    discardBtn.onclick = discardDrawn;
                    buttons.appendChild(discardBtn);
                }

                if (!state.knockerId) {
                    const knockBtn = document.createElement('button');
                    knockBtn.className = 'btn btn-danger';
                    knockBtn.textContent = 'üîî Knock (End Round)';
                    knockBtn.onclick = knock;
                    buttons.appendChild(knockBtn);
                }
            } else if (card.type === 'peek') {
                title.textContent = 'üëÅÔ∏è Peek: Choose a card to look at';
                
                const me = state.players.find(p => p.id === myId);
                me.hand.forEach((cardData, idx) => {
                    const btn = document.createElement('button');
                    btn.className = cardData.isKnown ? 'btn btn-secondary' : 'btn btn-primary';
                    btn.textContent = `Card ${idx + 1}${cardData.isKnown ? ' (seen)' : ''}`;
                    btn.onclick = () => usePeek(idx);
                    buttons.appendChild(btn);
                });
            } else if (card.type === 'swap') {
                if (!swapState.active) {
                    // Initial swap screen - show option to swap or decline
                    title.textContent = 'üîÑ Swap Card: Exchange one of your cards with an opponent (blind!)';

                    const startSwapBtn = document.createElement('button');
                    startSwapBtn.className = 'btn btn-primary';
                    startSwapBtn.textContent = 'Start Swap';
                    startSwapBtn.onclick = startSwapFlow;
                    buttons.appendChild(startSwapBtn);

                    const declineBtn = document.createElement('button');
                    declineBtn.className = 'btn btn-secondary';
                    declineBtn.textContent = 'Decline (Skip)';
                    declineBtn.onclick = declineSwap;
                    buttons.appendChild(declineBtn);
                } else {
                    // During swap flow - show progress and cancel option
                    if (swapState.step === 'select-my-card') {
                        title.textContent = 'üîÑ Step 1/3: Click one of YOUR cards to swap';
                    } else if (swapState.step === 'select-opponent') {
                        title.textContent = `üîÑ Step 2/3: Click the OPPONENT you want to swap with (selected your card ${swapState.myCardIndex + 1})`;
                    } else if (swapState.step === 'select-opponent-card') {
                        const opponent = state.players.find(p => p.id === swapState.opponentId);
                        title.textContent = `üîÑ Step 3/3: Click ${opponent.name}'s card to swap (your card ${swapState.myCardIndex + 1})`;
                    }

                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn btn-danger';
                    cancelBtn.textContent = 'Cancel Swap';
                    cancelBtn.onclick = cancelSwapFlow;
                    buttons.appendChild(cancelBtn);
                }
            } else if (card.type === 'draw2') {
                title.textContent = '‚ûï Draw 2: Activating...';
                useDraw2();
            } else if (card.type === 'addcard') {
                title.textContent = 'üé¥ Add Card: Adding card to your hand...';
                useAddCard();
            }
        }

        function showScores(state) {
            document.getElementById('gameBoard').style.display = 'block';
            document.getElementById('scoresArea').style.display = 'block';
            document.getElementById('actionPanel').style.display = 'none';

            const scores = document.getElementById('scores');
            const sortedPlayers = [...state.players].sort((a, b) => a.score - b.score);
            
            scores.innerHTML = sortedPlayers.map((player, idx) => `
                <div class="score-item ${idx === 0 ? 'winner' : ''}">
                    <span>
                        ${idx === 0 ? 'üèÜ ' : ''}
                        ${player.name}
                        ${player.id === myId ? ' (You)' : ''}
                    </span>
                    <span class="score-value">${player.score} pts</span>
                </div>
            `).join('');
        }

        // ============ CARD RENDERING ============

        function renderCard(element, card) {
            element.className = 'card';
            
            if (card.type === 'hidden') {
                element.classList.add('hidden');
                element.innerHTML = '?';
            } else if (card.type === 'number') {
                element.classList.add('number');
                element.innerHTML = card.value;
            } else {
                element.classList.add('power');
                element.innerHTML = getPowerCardDisplay(card.type);
            }
        }

        function getPowerCardDisplay(type) {
            switch(type) {
                case 'peek': return 'üëÅÔ∏è<br><small>Peek</small>';
                case 'swap': return 'üîÑ<br><small>Swap</small>';
                case 'draw2': return '‚ûï<br><small>Draw 2</small>';
                case 'addcard': return 'üé¥<br><small>Add Card</small>';
                default: return '?';
            }
        }

        function getCardDisplay(card) {
            if (card.type === 'number') return card.value.toString();
            return card.type.toUpperCase();
        }

        // ============ GAME ACTIONS ============

        function drawFromDeck() {
            if (!gameState.isMyTurn || gameState.drawnCard) return;
            socket.emit('drawFromDeck');
        }

        function drawFromDiscard() {
            if (!gameState.isMyTurn || gameState.drawnCard) return;
            socket.emit('drawFromDiscard');
        }

        function replaceCard(index) {
            socket.emit('replaceCard', { cardIndex: index });
        }

        function discardDrawn() {
            socket.emit('discardDrawn');
        }

        function usePeek(index) {
            socket.emit('usePeek', { cardIndex: index });
        }

        function useDraw2() {
            socket.emit('useDraw2');
        }

        function useAddCard() {
            socket.emit('useAddCard');
        }

        function knock() {
            if (confirm('Are you sure you want to knock? This will trigger the final round!')) {
                socket.emit('knock');
            }
        }

        // ============ SWAP CARD FLOW ============

        function startSwapFlow() {
            swapState.active = true;
            swapState.step = 'select-my-card';
            updateGameBoard(gameState);
        }

        function cancelSwapFlow() {
            resetSwapState();
            updateGameBoard(gameState);
        }

        function selectMyCardForSwap(cardIndex) {
            swapState.myCardIndex = cardIndex;
            swapState.step = 'select-opponent';
            updateGameBoard(gameState);
        }

        function selectSwapOpponent(opponentId) {
            swapState.opponentId = opponentId;
            swapState.step = 'select-opponent-card';
            updateGameBoard(gameState);
        }

        function selectOpponentCardForSwap(cardIndex) {
            swapState.opponentCardIndex = cardIndex;

            // Execute the swap
            socket.emit('useSwap', {
                myCardIndex: swapState.myCardIndex,
                opponentId: swapState.opponentId,
                opponentCardIndex: cardIndex
            });

            // Reset swap state
            resetSwapState();
        }

        function declineSwap() {
            if (confirm('Are you sure you want to skip the swap?')) {
                socket.emit('declineSwap');
                resetSwapState();
            }
        }
    </script>
</body>
</html>